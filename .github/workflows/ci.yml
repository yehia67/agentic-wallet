name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  FOUNDRY_PROFILE: ci

jobs:
  frontend-backend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install root dependencies
        run: npm install

      - name: Install backend dependencies
        run: cd backend && npm install --legacy-peer-deps

      - name: Install frontend dependencies
        run: cd frontend && npm install

      - name: Lint backend
        run: cd backend && npm run lint

      - name: Lint frontend
        run: cd frontend && npm run lint

      - name: Build backend
        run: cd backend && npm run build

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Run backend tests
        run: cd backend && npm test

  smart-contracts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install Foundry dependencies
        run: cd PromptNft && forge install

      - name: Check gas snapshots
        run: cd PromptNft && forge snapshot --check
        continue-on-error: true

      - name: Run smart contract tests
        run: cd PromptNft && forge test

      - name: Build smart contracts
        run: cd PromptNft && forge build

  summary:
    runs-on: ubuntu-latest
    needs: [frontend-backend, smart-contracts]
    if: always()
    
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.frontend-backend.result }}" == "success" && "${{ needs.smart-contracts.result }}" == "success" ]]; then
            echo "âœ… All checks passed!"
            echo "ğŸ” Linting: Passed"
            echo "ğŸ—ï¸ Build: Passed"
            echo "ğŸ§ª Tests: Passed"
            echo "ğŸ“œ Smart Contracts: Passed"
            echo "ğŸš€ Ready for deployment"
          else
            echo "âŒ Some checks failed!"
            echo "Frontend/Backend: ${{ needs.frontend-backend.result }}"
            echo "Smart Contracts: ${{ needs.smart-contracts.result }}"
            exit 1
          fi